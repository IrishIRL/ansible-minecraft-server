#!/bin/bash

# DECLARATIONS START #

  ## Temprature options
  CPU_USAGE=$(top -b -n 1 | grep "Cpu(s)" | awk '{print 100-$8}')
  DATE=$(date +%Y-%m-%d-%H:%M:%S)

  ## Telegram Bot options
  ### Token of Telegram bot
  TOKEN="{{ telegram_bot_token }}"

  ### Chat where to post the message
  CHAT="{{ telegram_chat_id }}"

# DECLARATIONS END #

  ## Write down the date and CPU to the log
  echo "[$DATE] - $CPU_USAGE" >> gpu_temp.log

  ## Check CPU
  ## If CPU is over 90%, then it sends a warning message both to telegram and minecraft server
  if [ $CPU_USAGE -gt 90 ]
  then
      docker exec minecraft-server mc-send-to-console say "§4[WARNING] §fCurrent CPU usage percentage: §4$CPU_USAGE"
      curl "https://api.telegram.org/bot$TOKEN/sendMessage?chat_id=$CHAT&text=\[WARNING\] CPU usage percentage: $CPU_USAGE"
  ## Otherwise it sends information only to minecraft server
  elif [ $CPU_USAGE -gt 70 ]
  then
      docker exec minecraft-server mc-send-to-console say "§6[INFO] §fCurrent CPU usage percentage: §6$CPU_USAGE"
  else
      docker exec minecraft-server mc-send-to-console say "Current CPU usage percentage: §2$CPU_USAGE"
  fi
